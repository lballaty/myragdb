# File: docker-compose.yml
# Description: Docker Compose configuration for local development and testing
# Author: Libor Ballaty <libor@arionetworks.com>
# Created: 2026-01-07

version: '3.8'

services:
  # MyRAGDB API Server
  myragdb:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - MYRAGDB_PORT=3003
      - MEILISEARCH_URL=http://meilisearch:7700
      - CHROMA_URL=http://chroma:8000
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - myragdb-logs:/app/logs
      - myragdb-data:/app/data
    depends_on:
      meilisearch:
        condition: service_healthy
      chroma:
        condition: service_healthy
    networks:
      - myragdb-network
    command: python -m myragdb.api.server

  # Meilisearch for keyword search
  meilisearch:
    image: getmeili/meilisearch:v1.6.0
    ports:
      - "7700:7700"
    environment:
      - MEILI_ENV=development
      - MEILI_MASTER_KEY=development-key
    volumes:
      - meilisearch-data:/meili_data
    networks:
      - myragdb-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Chroma for vector search
  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    networks:
      - myragdb-network
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - CHROMA_DB_IMPL=duckdb+parquet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL for metadata
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=myragdb
      - POSTGRES_USER=myragdb
      - POSTGRES_PASSWORD=myragdb-dev-password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - myragdb-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myragdb"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  myragdb-logs:
    driver: local
  myragdb-data:
    driver: local
  meilisearch-data:
    driver: local
  chroma-data:
    driver: local
  postgres-data:
    driver: local

networks:
  myragdb-network:
    driver: bridge
