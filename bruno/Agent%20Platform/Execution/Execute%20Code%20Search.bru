meta {
  name: Execute Code Search Template
  type: http
  seq: 2
  tags: @execution, @template, @api, @integration
}

post {
  url: {{api_base_url}}{{agent_base_path}}/execute
}

headers {
  Content-Type: application/json
}

body {
  json {
    request_type: "code_search"
    parameters: {
      query: "authentication"
      limit: 5
    }
    execution_id: "test_code_search_{{$timestamp}}"
  }
}

assert {
  res.status: in [200, 201]
  res.body.status: in ["completed", "failed"]
  res.body.execution_id: isNotEmpty
  res.body.workflow_name: eq "code_search"
  res.body.steps_completed: isNumber
  res.body.total_steps: isNumber
}

tests {
  test("Should execute code_search template", function() {
    expect(res.status).to.be.oneOf([200, 201]);
  });

  test("Should return execution result with required fields", function() {
    expect(res.body).to.have.property("execution_id");
    expect(res.body).to.have.property("status");
    expect(res.body).to.have.property("workflow_name");
    expect(res.body.workflow_name).to.equal("code_search");
  });

  test("Should track step progress", function() {
    expect(res.body.steps_completed).to.be.a("number");
    expect(res.body.total_steps).to.be.a("number");
    expect(res.body.steps_completed).to.be.lte(res.body.total_steps);
  });

  test("Should have step details", function() {
    expect(res.body).to.have.property("step_details");
    expect(res.body.step_details).to.be.an("array");
  });

  if (res.body.status === "completed") {
    test("Should have result data on completion", function() {
      expect(res.body).to.have.property("result");
    });
  }
}
