#!/bin/bash
# MyRAGDB Launcher Script

# Get the directory where this app bundle is located
APP_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_BUNDLE="$(dirname "$(dirname "$APP_PATH")")"
PROJECT_ROOT="$(dirname "$APP_BUNDLE")"

# Change to project directory
cd "$PROJECT_ROOT"

# Trap signals to run stop.sh when app is quit (via Force Quit)
cleanup() {
    "$PROJECT_ROOT/stop.sh" 2>/dev/null
    exit 0
}

# Register signal handlers for graceful shutdown
trap cleanup SIGTERM SIGINT SIGHUP EXIT

# Check if services are already running (relaunch scenario)
if lsof -Pi :3003 -sTCP:LISTEN -t >/dev/null 2>&1; then
    # Services already running - just open browser
    open "http://localhost:3003"
    # Exit immediately since services are already managed by another instance
    exit 0
fi

# Run the startup script (first launch)
./start.sh > /dev/null 2>&1

# Wait for server to be ready
for i in {1..10}; do
    if lsof -Pi :3003 -sTCP:LISTEN -t >/dev/null 2>&1; then
        break
    fi
    sleep 1
done

# Open web UI in default browser
open "http://localhost:3003"

# Keep the app running in background (appears in Dock while services are running)
# To stop: Use "Force Quit" from Dock, or run: ./stop.sh
# Double-click app again to reopen web UI in browser
while true; do
    sleep 2
    # Check if any of the services are still running
    if [ ! -f "$PROJECT_ROOT/.server.pid" ] && [ ! -f "$PROJECT_ROOT/.middleware.pid" ]; then
        exit 0
    fi
done
